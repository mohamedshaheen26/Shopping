<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Management</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <header>
    <!-- NAV  -->
    <div class="container">
      <a href="#" class="logo">Our <span>S</span>tore</a>
      <nav>
        <ul class="links">
          <li>
            <a class="home" href="index.html">
              Home
            </a>
          </li>
          <li>
            <a href="Products.html">
              Products
            </a>
          </li>
        </ul>
      </nav>
      <nav>
        <ul>
          <li>
            <a class="cart_icon" href="javascript:void(0)" id="cart-icon" title="Add to Card">
              <i class="fas fa-shopping-cart"></i>
            </a>
          </li>
          <li>
            <a href="login.html" id="logoutButton" title="Logout">
              <i class="fa-solid fa-arrow-right-from-bracket"></i>
            </a>
          </li>
        </ul>
      </nav>

      <div class="cart">
        <h2 class="cart-title">Your Cart</h2>

        <!-- CONTENT  -->
        <div class="cart-content"></div>

        <!-- TOTAL   -->
        <div class="total">
          <div class="total-title">Total</div>
          <div class="total-price">$0</div>
        </div>
        <!-- BUY BUTTON  -->
        <button type="button" class="btn-buy" onclick="buyNow()">Buy Now</button>
        <!-- CART CLOSE  -->
        <a href="javascript:void(0)">
          <i class='fas fa-times' id="cart-close"></i>
        </a>
      </div>
    </div>
  </header>

  <section class="shop">
    <div class="container">
      <!-- Alert Container -->
      <div id="alertContainer" class="container mt-3"></div>
      <div class="row justify-content-center">
        <div class="col-md-6">
          <div class="shopping-app text-center">
            <h1 class="section-title mb-4">Products</h1>

            <div class="d-flex justify-content-between align-items-center gap-2 mb-3">
              <!-- Button to trigger the "Add Category" modal -->
              <button type="button" class="btn btn-success mb-3" data-bs-toggle="modal"
                data-bs-target="#addCategoryModal">
                Add Category
              </button>

              <!-- Button to trigger the "Add Product" modal -->
              <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal"
                data-bs-target="#addProductModal">
                Add Product
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Category Modal -->
      <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addCategoryModalLabel">Add Category</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <!-- Add Category Form -->
              <form>
                <div class="mb-3">
                  <label for="categoryName" class="form-label">Category Name</label>
                  <input type="text" class="form-control" id="categoryName" required />
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" onclick="addCategory()">Add Category</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Add Product Modal -->
      <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel"
        aria-hidden="true">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="addProductModalLabel">Add Product</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <!-- Add Product Form -->
              <form>
                <div class="mb-3">
                  <label for="itemName" class="form-label">Product Name</label>
                  <input type="text" class="form-control" id="itemName" required />
                </div>
                <div class="mb-3">
                  <label for="itemPrice" class="form-label">Price</label>
                  <input type="number" class="form-control" id="itemPrice" required />
                </div>
                <div class="mb-3">
                  <label for="itemDescription" class="form-label">Description</label>
                  <input type="text" class="form-control" id="itemDescription" />
                </div>
                <div class="mb-3">
                  <label for="itemStock" class="form-label">Stock</label>
                  <input type="number" class="form-control" id="itemStock" />
                </div>
                <div class="mb-3">
                  <label for="categorySelect" class="form-label">Category</label>
                  <select class="form-select" id="categorySelect" required>
                    <!-- Options will be populated dynamically -->
                  </select>
                </div>
                <div class="mb-3">
                  <label for="itemImage" class="form-label">Product Image</label>
                  <input type="file" class="form-control" id="itemImage" accept="image/*" required />
                </div>
              </form>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-primary" onclick="addItem()">Add Product</button>
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
          </div>
        </div>
      </div>

      <div class="items">
        <div class="row" id="items">
          <!-- Product sections will be populated dynamically -->
        </div>
      </div>
    </div>
  </section>
  <!-- Bootstrap JS (required for modal and alert functionality) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE_URL = "https://nshopping.runasp.net/api";
    let userCartId = null; // Store the user's cart ID
    const userId = window.localStorage.getItem("userId"); // Replace with the actual user ID
    let cartId = null;
    let itemsInCart = new Set();
    // Fetch and display categories
    async function fetchCategories() {
      try {
        const response = await fetch(`${API_BASE_URL}/Category/AllCategories`);
        if (!response.ok) throw new Error("Failed to fetch categories");

        const categories = await response.json();

        // Populate the category dropdown in the modal
        const categorySelect = document.getElementById("categorySelect");
        categorySelect.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Select a category";
        categorySelect.appendChild(defaultOption);

        categories.forEach((category) => {
          const option = document.createElement("option");
          option.value = category.id;
          option.textContent = category.name;
          categorySelect.appendChild(option);
        });
      } catch (error) {
        console.error("Error fetching categories:", error);
        const categorySelect = document.getElementById("categorySelect");
        categorySelect.innerHTML = "<option value=''>Failed to load categories</option>";
      }
    }

    // Add a new category
    async function addCategory() {
      const categoryName = document.getElementById("categoryName").value;
      const addCategoryButton = document.querySelector("#addCategoryModal .btn-primary");

      if (!categoryName) {
        return alert("Please enter a category name");
      }

      // Disable the button and show loader
      addCategoryButton.disabled = true;
      addCategoryButton.innerHTML = `
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Adding...
      `;

      try {
        const response = await fetch(`${API_BASE_URL}/Category/Add`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ name: categoryName }),
        });

        if (!response.ok) {
          const errorResponse = await response.json();
          console.error("Error response:", errorResponse);
          throw new Error("Failed to add category");
        }

        const data = await response.json();
        console.log("Category added successfully:", data);

        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById("addCategoryModal"));
        modal.hide();

        // Show success alert
        showAlert("Category added successfully!", "success");

        // Refresh the category dropdown
        fetchCategories();
      } catch (error) {
        console.error("Error adding category:", error);
        showAlert("Failed to add category. Please try again.", "danger");
      } finally {
        // Re-enable the button and reset its text
        addCategoryButton.disabled = false;
        addCategoryButton.innerHTML = "Add Category";
      }
    }

    // Add a new item
    async function addItem() {
      const itemName = document.getElementById("itemName").value;
      const itemPrice = document.getElementById("itemPrice").value;
      const itemDescription = document.getElementById("itemDescription").value;
      const itemStock = document.getElementById("itemStock").value;
      const categorySelect = document.getElementById("categorySelect");
      const categoryId = categorySelect.value;
      const itemImage = document.getElementById("itemImage").files[0];
      const addProductButton = document.querySelector("#addProductModal .btn-primary");

      if (
        !itemName ||
        !itemPrice ||
        !itemDescription ||
        !itemStock ||
        !categoryId ||
        !itemImage
      ) {
        return alert("Please fill all fields and select a category and image");
      }

      // Disable the button and show loader
      addProductButton.disabled = true;
      addProductButton.innerHTML = `
        <span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>
        Adding...
      `;

      const formData = new FormData();
      formData.append("Name", itemName);
      formData.append("Description", itemDescription);
      formData.append("Price", itemPrice);
      formData.append("Stock", itemStock);
      formData.append("CategoryId", categoryId);
      formData.append("Image", itemImage);

      try {
        const response = await fetch(`${API_BASE_URL}/Product`, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          const errorResponse = await response.json();
          console.error("Error response:", errorResponse);
          throw new Error("Failed to add item");
        }

        const data = await response.json();

        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById("addProductModal"));
        modal.hide();

        // Show success alert
        showAlert("Product added successfully!", "success");

        // Refresh the list of items
        fetchItems();

        // Reset the form
        resetForm();
      } catch (error) {
        console.error("Error adding item:", error);
        showAlert("Failed to add product. Please try again.", "danger");
      } finally {
        // Re-enable the button and reset its text
        addProductButton.disabled = false;
        addProductButton.innerHTML = "Add Product";
      }
    }

    // Fetch and display items
    async function fetchItems() {
      try {
        const response = await fetch(`${API_BASE_URL}/Product`);
        if (!response.ok) throw new Error("Failed to fetch items");

        const items = await response.json();

        // Render items
        renderItems(items);
      } catch (error) {
        console.error("Error fetching items:", error);
        const itemsContainer = document.getElementById("items");
        itemsContainer.innerHTML = "<p class='text-danger'>Failed to load items. Check the console for details.</p>";
      }
    }

    // Render items
    function renderItems(items) {
      const itemsContainer = document.getElementById("items");
      itemsContainer.innerHTML = "";

      items.forEach((item) => {
        const itemElement = document.createElement("div");
        itemElement.className = "col-sm-6 col-md-4 col-lg-3 mb-4";
        itemElement.innerHTML = `
      <div class="product-box">
        <img src="images/backpack.png" alt="${item.name}" class="product-img">
        <h2 class="product-title">${item.name}</h2>
        <span class="product-price">Price: $${item.price}</span>
        <a href="javascript:void(0)" class="add-cart" data-item-id="${item.id}" data-item='${JSON.stringify(item)}' onclick="addToCart('${userId}', this)">
          <i class='fas fa-shopping-cart'></i>
        </a>
        <a href="javascript:void(0)" class="text-danger">
          <i class='fas fa-trash delete-item' onclick="deleteItem(${item.id})"></i>
        </a>
      </div>
    `;
        itemsContainer.appendChild(itemElement);
      });
    }
    // Add to cart
    async function addToCart(userId, element) {
      // Parse the item string back into an object
      const itemString = element.getAttribute("data-item");
      const item = JSON.parse(itemString);

      // If the user doesn't have a cart, create one
      if (!userCartId) {
        userCartId = await createCart(userId);
        if (!userCartId) return; // Exit if cart creation fails
      }

      // Add the item to the cart
      const cartItem = await addItemToCart(userCartId, item.id, 1);

      if (cartItem) {
        // Update the cart UI
        await fetchUserCart(userId);
        showAlert(`${item.name} added to cart!`, "success");

        // Disable the "Add to Cart" button for this item
        const addCartButton = document.querySelector(`.add-cart[data-item-id="${item.id}"]`);
        if (addCartButton) {
          addCartButton.classList.add("disabled");
          addCartButton.innerHTML = `<i class='fas fa-shopping-cart'></i> Added`;
        }
      }
    }

    // Create a cart for the user
    async function createCart(userId) {
      try {
        const response = await fetch(`${API_BASE_URL}/Cart/Create/${userId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
        });

        if (!response.ok) {
          throw new Error("Failed to create cart");
        }

        const cart = await response.json();
        return cart.id; // Return the cart ID
      } catch (error) {
        console.error("Error creating cart:", error);
        showAlert("Failed to create cart. Please try again.", "danger");
        return null;
      }
    }

    // Add item to cart
    async function addItemToCart(cartId, productId, quantity) {
      try {
        const response = await fetch(`${API_BASE_URL}/Cart/AddItem/${cartId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ productId, quantity }),
        });

        if (!response.ok) {
          throw new Error("Failed to add item to cart");
        }

        const cartItem = await response.json();
        return cartItem;
      } catch (error) {
        console.error("Error adding item to cart:", error);
        showAlert("Failed to add item to cart. Please try again.", "danger");
        return null;
      }
    }

    // Fetch user's cart
    async function fetchUserCart(userId) {
      try {
        const response = await fetch(`${API_BASE_URL}/Cart/GetByUser/${userId}`, {
          headers: {
            "Authorization": `Bearer ${localStorage.getItem("token")}`,
            "accept": "text/plain", // Add this header if required by the API
          },
        });

        if (!response.ok) {
          throw new Error("Failed to fetch user cart");
        }

        const cart = await response.json();
        cartId = cart.id;
        const cartItems = cart.cartItems || [];
        updateCartUI(cartItems); // Update the cart UI
        return cart;
      } catch (error) {
        console.error("Error fetching user cart:", error);
        showAlert("Failed to fetch cart. Please try again.", "danger");
        return null;
      }
    }

    // Remove item from cart
    async function removeFromCart(cartItemId) {
      try {
        const response = await fetch(`${API_BASE_URL}/Cart/RemoveItem/${cartId}/${cartItemId}`, {
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${localStorage.getItem("token")}`,
          },
        });

        if (!response.ok) {
          throw new Error("Failed to remove item from cart");
        }

        // If the item is successfully removed, fetch the updated cart
        await fetchUserCart(userId);
        showAlert("Item removed from cart!", "success");
      } catch (error) {
        console.error("Error removing item from cart:", error);
        showAlert("Failed to remove item from cart. Please try again.", "danger");
      }
    }

    // Update the quantity of an item in the cart
    async function updateCartItemQuantity(cartItemId, newQuantity) {
      if (newQuantity < 1) {
        // If the new quantity is less than 1, remove the item from the cart
        await removeFromCart(cartItemId);
        return;
      }

      try {
        // Step 1: Fetch the cart item details
        const cartResponse = await fetch(`${API_BASE_URL}/Cart/GetByUser/${userId}`, {
          headers: {
            "Authorization": `Bearer ${localStorage.getItem("token")}`,
            "accept": "text/plain",
          },
        });

        if (!cartResponse.ok) {
          throw new Error("Failed to fetch cart details");
        }

        const cart = await cartResponse.json();
        const cartItem = cart.cartItems.find((item) => item.id === cartItemId);

        if (!cartItem) {
          throw new Error("Cart item not found");
        }

        // Step 2: Remove the item from the cart
        const removeResponse = await fetch(`${API_BASE_URL}/Cart/RemoveItem/${cartId}/${cartItemId}`, {
          method: "DELETE",
          headers: {
            "Authorization": `Bearer ${localStorage.getItem("token")}`,
          },
        });

        if (!removeResponse.ok) {
          throw new Error("Failed to remove item from cart");
        }

        // Step 3: Add the item back to the cart with the updated quantity
        const addResponse = await fetch(`${API_BASE_URL}/Cart/AddItem/${cartId}`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${localStorage.getItem("token")}`,
          },
          body: JSON.stringify({
            productId: cartItem.productId,
            quantity: newQuantity,
          }),
        });

        if (!addResponse.ok) {
          throw new Error("Failed to add item to cart");
        }

        // Step 4: Refresh the cart UI
        await fetchUserCart(userId);
      } catch (error) {
        console.error("Error updating item quantity:", error);
        showAlert("Failed to update item quantity. Please try again.", "danger");
      }
    }

    // Update the cart UI to include buttons for increasing/decreasing quantity
    function updateCartUI(cartItems) {
      const cartContent = document.querySelector(".cart-content");
      const totalPriceElement = document.querySelector(".total-price");

      cartContent.innerHTML = "";

      // Handle empty cart
      if (!cartItems || cartItems.length === 0) {
        cartContent.innerHTML = "<p>Your cart is empty.</p>";
        totalPriceElement.textContent = "$0";
        return;
      }

      cartItems.forEach((item) => {
        const cartItemElement = document.createElement("div");
        cartItemElement.className = "cart-item";
        cartItemElement.innerHTML = `
          <div class="row">
            <div class="col-9">
              <h6>${item.productName}</h6>
              <p>$${item.price}</p>
            </div>
            <div class="col-3">
              <button class="btn btn-sm btn-danger" onclick="removeFromCart(${item.id})">
                <i class="fas fa-trash"></i>
              </button>
            </div>
            <div class="col-12">
              <div class="d-flex justify-content-center align-items-center gap-3">
                <button class="quantity" ${item.quantity === 1 ? "disabled" : ""} onclick="updateCartItemQuantity(${item.id}, ${item.quantity - 1})">
                  <i class="fas fa-minus"></i>
                </button>
                <span id="quantity-${item.id}">${item.quantity}</span>
                <button class="quantity" onclick="updateCartItemQuantity(${item.id}, ${item.quantity + 1})">
                  <i class="fas fa-plus"></i>
                </button>
              </div>
            </div>
          </div>`;
        cartContent.appendChild(cartItemElement);
      });

      const totalPrice = cartItems.reduce((total, item) => total + item.price * item.quantity, 0);
      totalPriceElement.textContent = `$${totalPrice.toFixed(2)}`;
    }
    // Remove item from cart
    async function removeItemFromCart(cartId, cartItemId) {
      try {
        const response = await fetch(`${API_BASE_URL}/Cart/RemoveItem/${cartId}/${cartItemId}`, {
          method: "DELETE",
        });

        if (!response.ok) {
          throw new Error("Failed to remove item from cart");
        }

        return true; // Success
      } catch (error) {
        console.error("Error removing item from cart:", error);
        showAlert("Failed to remove item from cart. Please try again.", "danger");
        return false;
      }
    }

    // Buy Now
    async function buyNow() {
      if (!userCartId) {
        showAlert("Your cart is empty. Add items to proceed.", "warning");
        return;
      }

      // Simulate a successful purchase
      showAlert("Thank you for your purchase!", "success");

      // Clear the cart UI locally
      updateCartUI([]);

      // Optionally, reset the cart ID (if needed)
      userCartId = null;
    }

    // Show alert
    function showAlert(message, type) {
      const alertContainer = document.getElementById("alertContainer");

      // Create alert element
      const alertElement = document.createElement("div");
      alertElement.className = `alert alert-${type} alert-dismissible fade show`;
      alertElement.setAttribute("role", "alert");
      alertElement.innerHTML = message;
      alertContainer.style.left = "0";
      alertContainer.style.transition = "left 0.5s ease-in-out";
      // Add the alert to the container
      alertContainer.appendChild(alertElement);

      // Automatically remove the alert after 5 seconds
      setTimeout(() => {
        alertContainer.style.left = "-500px";
        alertContainer.style.transition = "left 0.5s ease-in-out";
      }, 2000);
      setTimeout(() => {
        alertElement.remove();
      }, 4000);
    }

    // Reset form
    function resetForm() {
      document.getElementById("itemName").value = "";
      document.getElementById("itemPrice").value = "";
      document.getElementById("itemDescription").value = "";
      document.getElementById("itemStock").value = "";
      document.getElementById("categorySelect").value = "";
      document.getElementById("itemImage").value = "";
    }

    // Reset category form
    function resetCategoryForm() {
      document.getElementById("categoryName").value = "";
    }

    // Add event listener to reset the form when the modal is closed
    document.getElementById("addProductModal").addEventListener("hidden.bs.modal", () => {
      resetForm();
    });

    document.getElementById("addCategoryModal").addEventListener("hidden.bs.modal", () => {
      resetCategoryForm();
    });

    // Initial fetch to display data
    fetchCategories();
    fetchItems();
    fetchUserCart(userId); // Fetch the user's cart on page load
  </script>

  <script src="js/main.js"></script>
</body>

</html>