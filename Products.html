<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Management</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">

  <link rel="stylesheet" href="css/style.css">
</head>

<body>
  <header>
    <div class="container">
      <h1>Our Store</h1>
      <nav>
        <ul>
          <li>
            <a class="cart" href="Products.html">
              Products
            </a>
          </li>
          <li>
            <a class="cart" href="cart.html">
              <i class="fas fa-shopping-cart"></i>
              Cart
            </a>
          </li>
          <li>
            <a href="login.html" id="logoutButton">Logout</a>
          </li>
        </ul>
      </nav>
    </div>
  </header>

  <div class="container mt-5">
    <!-- Alert Container -->
    <div id="alertContainer" class="container mt-3"></div>
    <div class="shopping-app text-center">
      <h1 class="mb-4">Shopping</h1>

      <!-- Button to trigger the "Add Category" modal -->
      <button type="button" class="btn btn-success mb-3" data-bs-toggle="modal" data-bs-target="#addCategoryModal">
        Add Category
      </button>

      <!-- Button to trigger the "Add Product" modal -->
      <button type="button" class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addProductModal">
        Add Product
      </button>
    </div>

    <!-- Add Category Modal -->
    <div class="modal fade" id="addCategoryModal" tabindex="-1" aria-labelledby="addCategoryModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addCategoryModalLabel">Add Category</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Add Category Form -->
            <form>
              <div class="mb-3">
                <label for="categoryName" class="form-label">Category Name</label>
                <input type="text" class="form-control" id="categoryName" required />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="addCategory()">Save changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Add Product Modal -->
    <div class="modal fade" id="addProductModal" tabindex="-1" aria-labelledby="addProductModalLabel"
      aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="addProductModalLabel">Add Product</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
          </div>
          <div class="modal-body">
            <!-- Add Product Form -->
            <form>
              <div class="mb-3">
                <label for="itemName" class="form-label">Product Name</label>
                <input type="text" class="form-control" id="itemName" required />
              </div>
              <div class="mb-3">
                <label for="itemPrice" class="form-label">Price</label>
                <input type="number" class="form-control" id="itemPrice" required />
              </div>
              <div class="mb-3">
                <label for="itemDescription" class="form-label">Description</label>
                <input type="text" class="form-control" id="itemDescription" required />
              </div>
              <div class="mb-3">
                <label for="itemStock" class="form-label">Stock</label>
                <input type="number" class="form-control" id="itemStock" required />
              </div>
              <div class="mb-3">
                <label for="categorySelect" class="form-label">Category</label>
                <select class="form-select" id="categorySelect" required>
                  <!-- Options will be populated dynamically -->
                </select>
              </div>
              <div class="mb-3">
                <label for="itemImage" class="form-label">Product Image</label>
                <input type="file" class="form-control" id="itemImage" accept="image/*" required />
              </div>
            </form>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button type="button" class="btn btn-primary" onclick="addItem()">Save changes</button>
          </div>
        </div>
      </div>
    </div>
    <div class="Categories">
      <h3>Categories</h3>
      <ul id="categoryFilter" class="categoryFilter">
        <!-- Categories will be populated dynamically -->
      </ul>
    </div>
    <div id="items">
      <!-- Product sections will be populated dynamically -->
    </div>
  </div>

  <!-- Bootstrap JS (required for modal and alert functionality) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    const API_BASE_URL = "https://nshopping.runasp.net/api";

    // Fetch and display categories
    async function fetchCategories() {
      try {
        const response = await fetch(`${API_BASE_URL}/Category/AllCategories`);
        if (!response.ok) throw new Error("Failed to fetch categories");

        const categories = await response.json();
        console.log("Fetched categories:", categories);

        // Populate the category dropdown in the modal
        const categorySelect = document.getElementById("categorySelect");
        categorySelect.innerHTML = "";
        const defaultOption = document.createElement("option");
        defaultOption.value = "";
        defaultOption.textContent = "Select a category";
        categorySelect.appendChild(defaultOption);

        // Populate the sidebar with categories
        const categoryFilter = document.getElementById("categoryFilter");
        categoryFilter.innerHTML = "";

        categories.forEach((category) => {
          // Add to dropdown
          const option = document.createElement("option");
          option.value = category.id;
          option.textContent = category.name;
          categorySelect.appendChild(option);

          // Add to sidebar
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.href = "#";
          a.textContent = category.name;
          a.dataset.categoryId = category.id;
          a.addEventListener("click", () => filterItemsByCategory(category.id));
          li.appendChild(a);
          categoryFilter.appendChild(li);
        });
      } catch (error) {
        console.error("Error fetching categories:", error);
        const categorySelect = document.getElementById("categorySelect");
        categorySelect.innerHTML = "<option value=''>Failed to load categories</option>";
      }
    }

    // Filter items by category
    async function filterItemsByCategory(categoryId) {
      try {
        const response = await fetch(`${API_BASE_URL}/Product`);
        if (!response.ok) throw new Error("Failed to fetch items");

        const items = await response.json();
        const filteredItems = items.filter((item) => item.categoryId === categoryId);

        // Render the filtered items
        renderGroupedItems({ [categoryId]: filteredItems });
      } catch (error) {
        console.error("Error filtering items:", error);
        showAlert("Failed to filter items. Please try again.", "danger");
      }
    }

    // Add a new category
    async function addCategory() {
      const categoryName = document.getElementById("categoryName").value;

      if (!categoryName) {
        return alert("Please enter a category name");
      }

      try {
        const response = await fetch(`${API_BASE_URL}/Category/Add`, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ name: categoryName }),
        });

        if (!response.ok) {
          const errorResponse = await response.json();
          console.error("Error response:", errorResponse);
          throw new Error("Failed to add category");
        }

        const data = await response.json();
        console.log("Category added successfully:", data);

        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById("addCategoryModal"));
        modal.hide();

        // Show success alert
        showAlert("Category added successfully!", "success");

        // Refresh the category dropdown and sidebar
        fetchCategories();
      } catch (error) {
        console.error("Error adding category:", error);
        showAlert("Failed to add category. Please try again.", "danger");
      }
    }

    // Add a new item
    async function addItem() {
      const itemName = document.getElementById("itemName").value;
      const itemPrice = document.getElementById("itemPrice").value;
      const itemDescription = document.getElementById("itemDescription").value;
      const itemStock = document.getElementById("itemStock").value;
      const categorySelect = document.getElementById("categorySelect");
      const categoryId = categorySelect.value;
      const itemImage = document.getElementById("itemImage").files[0];

      if (
        !itemName ||
        !itemPrice ||
        !itemDescription ||
        !itemStock ||
        !categoryId ||
        !itemImage
      ) {
        return alert("Please fill all fields and select a category and image");
      }

      const formData = new FormData();
      formData.append("Name", itemName);
      formData.append("Description", itemDescription);
      formData.append("Price", itemPrice);
      formData.append("Stock", itemStock);
      formData.append("CategoryId", categoryId);
      formData.append("Image", itemImage);

      try {
        const response = await fetch(`${API_BASE_URL}/Product`, {
          method: "POST",
          body: formData,
        });

        if (!response.ok) {
          const errorResponse = await response.json();
          console.error("Error response:", errorResponse);
          throw new Error("Failed to add item");
        }

        const data = await response.json();
        console.log("Item added successfully:", data);

        // Close the modal
        const modal = bootstrap.Modal.getInstance(document.getElementById("addProductModal"));
        modal.hide();

        // Show success alert
        showAlert("Product added successfully!", "success");

        // Refresh the list of items
        fetchItems();

        // Reset the form
        resetForm();
      } catch (error) {
        console.error("Error adding item:", error);
        showAlert("Failed to add product. Please try again.", "danger");
      }
    }

    // Fetch and display items
    async function fetchItems() {
      try {
        const response = await fetch(`${API_BASE_URL}/Product`);
        if (!response.ok) throw new Error("Failed to fetch items");

        const items = await response.json();
        console.log("Fetched items:", items);

        // Group items by category
        const groupedItems = items.reduce((groups, item) => {
          const categoryName = item.categoryName || "Uncategorized";
          if (!groups[categoryName]) {
            groups[categoryName] = [];
          }
          groups[categoryName].push(item);
          return groups;
        }, {});

        // Render grouped items
        renderGroupedItems(groupedItems);
      } catch (error) {
        console.error("Error fetching items:", error);
        const itemsContainer = document.getElementById("items");
        itemsContainer.innerHTML = "<p class='text-danger'>Failed to load items. Check the console for details.</p>";
      }
    }

    // Render grouped items
    function renderGroupedItems(groupedItems) {
      const itemsContainer = document.getElementById("items");
      itemsContainer.innerHTML = "";

      // Loop through each category
      for (const [categoryName, products] of Object.entries(groupedItems)) {
        // Create a section for the category
        const categorySection = document.createElement("div");
        categorySection.className = "mb-5";
        categorySection.innerHTML = `
          <h3 class="category-title mb-3">${categoryName}</h3>
          <div class="row">
            ${products
            .map(
              (item) => `
              <div class="col-md-4 mb-4">
                <div class="card">
                  <div class="img">
                    <img src="images/backpack.png" class="card-img-top" alt="${item.name}" />
                    <button class="delete-btn" onclick="deleteItem('${item.id}')"><i class="fas fa-trash"></i></button>
                  </div>
                  <div class="card-body">
                    <div class="left">
                      <h5 class="card-title">${item.name}</h5>
                      <p class="card-price">Price: $${item.price}</p>
                    </div>
                    <div class="right">
                      <button class="btn btn-secondary add-to-cart">
                        Add to Cart
                      </button>
                    </div>
                    </div>
                </div>
              </div>
            `
            )
            .join("")}
          </div>
        `;

        // Add the category section to the container
        itemsContainer.appendChild(categorySection);
      }
    }

    // Delete an item
    async function deleteItem(itemId) {
      try {
        const response = await fetch(`${API_BASE_URL}/Product/${itemId}`, {
          method: "DELETE",
        });
        if (!response.ok) throw new Error("Failed to delete item");
        fetchItems(); // Refresh the list
      } catch (error) {
        console.error("Error deleting item:", error);
      }
    }

    // Show alert
    function showAlert(message, type) {
      const alertContainer = document.getElementById("alertContainer");

      // Create alert element
      const alertElement = document.createElement("div");
      alertElement.className = `alert alert-${type} alert-dismissible fade show`;
      alertElement.setAttribute("role", "alert");
      alertElement.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;

      // Add the alert to the container
      alertContainer.appendChild(alertElement);

      // Automatically remove the alert after 5 seconds
      setTimeout(() => {
        alertElement.remove();
      }, 5000);
    }

    // Reset form
    function resetForm() {
      document.getElementById("itemName").value = "";
      document.getElementById("itemPrice").value = "";
      document.getElementById("itemDescription").value = "";
      document.getElementById("itemStock").value = "";
      document.getElementById("categorySelect").value = "";
      document.getElementById("itemImage").value = "";
    }

    // Reset category form
    function resetCategoryForm() {
      document.getElementById("categoryName").value = "";
    }

    // Add event listener to reset the form when the modal is closed
    document.getElementById("addProductModal").addEventListener("hidden.bs.modal", () => {
      resetForm();
    });

    document.getElementById("addCategoryModal").addEventListener("hidden.bs.modal", () => {
      resetCategoryForm();
    });

    // Initial fetch to display data
    fetchCategories();
    fetchItems();
  </script>
</body>

</html>